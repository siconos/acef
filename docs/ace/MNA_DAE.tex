
\section{Unknowns}
Before go head, the unknowns vector X is subdivided:
\begin{enumerate}
\item[--] x contains only the dynamic unknowns(currents in inductor and tensions from capacitor branches)
\item[--] $Z_{s}$ contains only the non dynamic unknowns(Voltage nodes,... ).
\item[--] $Z_{ns}$ contains the useful currents and tensions for the non smooth components.
\end{enumerate}

\section{The non smooth components}
\subsection{Local formulation}
For each non smooth component, the complementarity condition is:
\[\left(\begin{array}{c}
\beta = zns_{i} = A_{i}x+B_{i}\lambda_{i}+C_{i}z_{s} + a_{i}\\
y_{i}=D_{i}x+E_{i}z_{s}+F_{i}\lambda_{i}+G_{i}zns_{i}+e_{i}\\
0 \leq y_{i} \, \perp \, \lambda_{i} \geq 0
\end{array}\right)\]
Where $zns_{i}$ is a voltage and currents vector. $a_{i},e_{i},\lambda_{i}$ and $y_{i}$ are some vectors. At the end
of this document, there are the diode and transistor examples.


\subsection{Global formulation}
It consists in writing all the complementary conditions in the same system. Following, an example with 5 non smooth components:

\[\left(\begin{array}{c}
  Z_{ns}\\
  \hline
  Z_{ns1} \\
  Z_{ns2} \\
  Z_{ns3} \\
  Z_{ns4} \\
  Z_{ns5} \\
\end{array}\right) =
\left(\begin{array}{c}
  C_{1x}\\
  \hline
  A1\\
  A2\\
  A3\\
  A4\\
  A5\\
\end{array}\right)*x +
\left(\begin{array}{c}
  C_{1s}\\
  \hline
  C1\\
  C2\\
  C3\\
  C4\\
  C5\\
\end{array}\right)*Z_{s} +
\left(\begin{array}{ccccc}
  C1_{\lambda}\\
  \hline
  B1&0&0&0&0\\
  0&B2&0&0&0\\
  0&0&B3&0&0\\
  0&0&0&B4&0\\
  0&0&0&0&B5\\
\end{array}\right)*
\left(\begin{array}{c}
  \lambda\\
  \hline
  \lambda _{1} \\
  \lambda _{2}\\
  \lambda _{3}\\
  \lambda _{4}\\
  \lambda _{5}\\
\end{array}\right)+
\left(\begin{array}{c}
  cst\\
  \hline
   cst_{1} \\
   cst_{2}\\
   cst_{3}\\
   cst_{4}\\
   cst_{5}\\
\end{array}\right)
\]

\[\left(\begin{array}{c}
  Y\\
  \hline
   Y_{1} \\
   Y_{2} \\
   Y_{3} \\
   Y_{4} \\
   Y_{5} \\
\end{array}\right) =
\left(\begin{array}{c}
  D_{1x}\\
  \hline
  D1\\
  D2\\
  D3\\
  D4\\
  D5\\
\end{array}\right)*x +
\left(\begin{array}{c}
  D_{1s}\\
  \hline
  E1\\
  E2\\
  E3\\
  E4\\
  E5\\
\end{array}\right)*Z_{s} +
\left(\begin{array}{ccccc}
  D1_{\lambda}\\
  \hline
  F1&0&0&0&0\\
  0&F2&0&0&0\\
  0&0&F3&0&0\\
  0&0&0&F4&0\\
  0&0&0&0&F5\\
\end{array}\right)*
\left(\begin{array}{c}
  \lambda\\
  \hline
   \lambda _{1} \\
   \lambda _{2}\\
   \lambda _{3}\\
   \lambda _{4}\\
   \lambda _{5}\\
\end{array}\right)+\]
\[
\left(\begin{array}{ccccc}
  D1_{ns}\\
  \hline
  G1&0&0&0&0\\
  0&G2&0&0&0\\
  0&0&G3&0&0\\
  0&0&0&G4&0\\
  0&0&0&0&G5\\
\end{array}\right)*
\left(\begin{array}{c}
  Zns\\
  \hline
   zns_{1} \\
   zns_{2}\\
   zns_{3}\\
   zns_{4}\\
   zns_{5}\
\end{array}\right)+
\left(\begin{array}{c}
  cst\\
  \hline
   cst_{1} \\
   cst_{2}\\
   cst_{3}\\
   cst_{4}\\
   cst_{5}\\
\end{array}\right)
\]
Finally, the global formulation form is : 

\[\left(\begin{array}{c}
Z_{ns}= C_{1x}x+C_{1zs}Z_{s}+C_{1\lambda}\lambda +C_{1s}\\
Y=D_{1x}x +D_{1zs}Z_{s}+D_{1ns}Z_{ns}+D_{1\lambda}\lambda+D_{1s}\\
0 \leq Y \, \perp \, \lambda \geq 0
\end{array}\right)\]
\newpage
\section{MNA and complementary conditions}
This part describes the automatic MLCP formulation from a circuit. It consists in adapting the
MNA to manage non-smooth model.

\subsection{Hypothesis}
The MNA assumes smooth branches are explicit functions of current or voltage. It means each smooth
branch is Voltage Defined (V.D.) or Current Defined (C.D.)\\

With the same assumption, all branches can be divided into following classes:\\
\begin{enumerate}
\item The  \underline{C.D. branches} 
\item The  \underline{V.D. branches}
 \item The  \underline{non smooth branches}
 \item The \underline{dynamical capacitor branches}
 \item The \underline{dynamical inductors branches}
\end{enumerate}



\subsection{Smooth equations, DAE system.}
It is the same physical equations than in the MNA. This part describes the form and the unknowns
used in our formulation.
\subsubsection{static equations}
\begin{enumerate}
  \item If a node is not connected to a capacitor then the Kirchhoff Current Law (KCL) is static. \\
  \item The V.D. equation (VDE) : \\
    A V.D. branch give an equation :
    \[V_{i}-V_{j} = \sum_{i}^{}a_{i}V_{i} + \sum_{j\in J}^{}b_{j}I_{j} +   source\]
    This equation comes from the branch constitution, not from Kirchoff. (ex : U = R*I)
\subsubsection{dynamic equations}
  \item If a node is connected to a capacitor then the Kirchhoff Current Law is dynamic (KCL).\\
    NB : The current in the capacitor branches is written with :
    \[I = C*\frac{d(V_{i} - V_{j})}{dt}\]
  \item The inductor law (IL) : 
     \[V_{i} - V_{j} = L*\frac{dI}{dt}\]
\end{enumerate}

These equations lead to a DAE of the form:
\[MX'+NX=s(t)\]
M is singular. But, with the good set of unknowns, it is possible to write a DAE of the form :
\[x' = A_{1x}x +A_{1zs}Z_{s} + A_{1ns}Z_{ns}+A_{1s}\]
\[0  = B_{1x}x+B_{1zs}Z_{s} + B_{1ns}Z_{ns}+B_{1s}\]

\input{DAE_FORM.tex}
\newpage
\section{Matrices formulation}

The previous section describes how get the following system:
\[\left(\begin{array}{c}
x'=A_{1x}x +A_{1zs}Z_{s} + A_{1ns}Z_{ns}+A_{1s}\\
0=B_{1x}x+B_{1zs}Z_{s} + B_{1ns}Z_{ns}+B_{1s}\\
Z_{ns}= C_{1x}x+C_{1zs}Z_{s}+C_{1\lambda}\lambda +C_{1s}\\
Y=D_{1x}x +D_{1zs}Z_{s}+D_{1ns}Z_{ns}+D_{1\lambda}\lambda+D_{1s}\\
0 \leq Y \, \perp \, \lambda \geq 0
\end{array}\right)\]
Substitute $Z_{ns}$:
\[\left(\begin{array}{cc}
R=A_{1ns}C_{1\lambda}&(eq1)\\
x'=(A_{1x}+A_{1ns}C_{1x})x +(A_{1zs}+A_{1ns}C_{1zs})Z_{s} +R\lambda+A_{1s} + A_{1ns}C_{1s}\\
x'=A_{2x}x +A_{2zs}Z_{s} +R \lambda +A_{2s}&(eq2)\\
0=(B_{1x}+B_{1ns}C_{1x})x+(B_{1zs}+B_{1ns}C_{1s})Z_{s} + B_{1ns}C_{1\lambda}\lambda +B_{1s} + B_{1ns}C_{1s} \\
0=B_{2x}x+B_{2zs}Z_{s} + B_{2\lambda}\lambda + B_{2s}&(eq3)\\
Y=(D_{1x}+D_{1ns}C_{1x})x+(D_{1zs}+D_{1ns}C_{1s})Z_{s}+(D_{1\lambda}+D_{1ns}C_{1\lambda})\lambda +D_{1s}+D_{1ns}C_{1s}=\\
Y=D_{2x}x+D_{2zs}Z_{s}+D_{2\lambda}\lambda + D_{2s} &(eq4)\\
0 \leq Y \, \perp \, \lambda \geq 0&(\perp)\\
\end{array}\right)\]
$A_{2s}, B_{2s}$ and $D_{2s}$ are vectors.

\subsection{Moreau time's stepping }
\[\left(\begin{array}{cc}
R=A_{1ns}C_{1\lambda}&(eq1)\\
x'=A_{2x}x +A_{2zs}Z_{s} +R \lambda +A_{2s}&(eq2)\\
0=B_{2x}x+B_{2zs}Z_{s} + B_{2\lambda}\lambda + B_{2s}&(eq3)\\
Y=D_{2x}x+D_{2zs}Z_{s}+D_{2\lambda}\lambda + D_{2s} &(eq4)\\
0 \leq Y \, \perp \, \lambda \geq 0&(\perp)\\
\end{array}\right)\]

 eq1 discretisation:
\[x(t_{i+1}) - x(t_{i})=h\theta A_{2x}x(t_{i+1})+h(1-\theta)A_{2x}x(t_{i}) +h\theta
A_{2zs}Z_{s}(t_{i+1}) +\]
\[h(1-\theta)A_{2zs}Z_s(t_{i}) +hR\lambda (t_{i+1}) + h\theta 'A_{2s}(t_{i+1}) +
h(1-\theta ')A_{2s}(t_{i})\]
We assume $(I-h\theta A_{2x})$ is regular,$W(I-h\theta A_{2x}) = I.$
\[x(t_{i+1})=Wx_{free}+h\theta WA_{2zs}Z_{s}(t_{i+1})+hWR\lambda (t_{i+1})  (eq5)\]
With:
\[x_{free}=(I+h(1-\theta)A_{2x})x(t_{i}) + h(1-\theta )A_{2zs}Zs(t_{i}) + h\theta 'A_{2s}(t_{i+1}) +
h(1-\theta ')A_{2s}(t_{i})\]
eq3 discretisation:
\[0 = B_{2x}x(t_{i+1})+B_{2zs}Z_{s}(t_{i+1}) + B_{2\lambda}\lambda(t_{i+1})+B_{2s}(t_{i+1})\]
With eq5:
\[0 = B_{2x}Wx_{free}+B_{2s}(t_{i+1})+(h\theta B_{2x} WA_{2zs}+B_{2zs}) Z_{s}(t_{i+1})+(hB_{2x}WR+B_{2\lambda})\lambda(t_{i+1})\]
Rename the matrices:
\[0 = q_{free}+B_{3zs} Z_{s}(t_{i+1})+B_{3\lambda}\lambda(t_{i+1})\]

eq4 discretisation:
\[Y(t_{i+1})=D_{2x}x(t_{i+1})+D_{2zs}Z_{s}(t_{i+1}) +D_{2\lambda}\lambda(t_{i+1})+D_{2s}(t_{i+1})\]
With eq5 and rename the matrices:
\[Y(t_{i+1})=D_{2x}Wx_{free}+ D_{2s}(t_{i+1})+(D_{2zs}+h\theta
D_{2x}WA_{2zs})Z_{s}(t_{i+1})+(D_{2\lambda} + hD_{2x}WR)\lambda(t_{i+1})\]
Rename the matrices:
\[Y(t_{i+1})=p_{free}+D_{3zs}Zs(t_{i+1}) +D_{3\lambda}\lambda (t_{i+1})\]

\paragraph{MLCP}
description:\\

\[W=\left(\begin{array}{c}W_{1}\\0\end{array}\right)\]
\[Z=\left(\begin{array}{c}Z_{1}\\Z_{2}\end{array}\right)\]
\[W=MZ+q\]
\[0 \leq W_{1} \, \perp \, Z_{1} \geq 0\]
\paragraph{MLCP instance}
We identify a MLCP:\\
\[W_{1} = Y(t_{i+1})\]
\[Z_{1} = \lambda(t_{i+1})\]
\[Z_{2} = Z_{s}(t_{i+1})\]
\[M = \left(\begin{array}{cc}
  D_{3\lambda}&D_{3zs}\\
B_{3\lambda}&B_{3zs}
\end{array}\right)\]
\[q=\left(\begin{array}{c}
p_{free}\\
q_{free}\end{array}\right)\]
\section{Conclusion}
This document demonstrates a way to develop an automatic circuit equation formulation. It shows that a Moreau's time
stepping lead to a MLCP. The following examples describe the method with non smooth circuits.



